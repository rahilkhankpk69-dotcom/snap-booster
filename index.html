<script>
const usernameInput = document.getElementById('username');
const passwordInput = document.getElementById('password');
const userDisplay = document.getElementById('userDisplay');
const modal = document.getElementById('settingsModal');
const modalUser = document.getElementById('modalUser');
const modalPass = document.getElementById('modalPass');
const scoreDisplay = document.getElementById('scoreDisplay');

let currentUser = null;

async function safeFetch(url, options = {}) {
  try {
    const res = await fetch(url, options);
    const text = await res.text();

    if (!res.ok) {
      alert(`Server mein masla: ${res.status} - ${text.substring(0, 100)}`);
      return null;
    }

    if (text.trim().startsWith('{') || text.trim().startsWith('[')) {
      return JSON.parse(text);
    } else {
      alert('Server se ghalat jawab aaya (JSON nahi mila)');
      return null;
    }
  } catch (err) {
    alert('Connection mein masla: ' + err.message);
    return null;
  }
}

async function handleLogin() {
  const user = usernameInput.value.trim();
  const pass = passwordInput.value.trim();
  if (!user || !pass) return alert("Username aur password daal bhai!");

  const data = await safeFetch('/api/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username: user, password: pass })
  });

  if (data && data.success) {
    currentUser = user;
    localStorage.setItem('snapUser', user);
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('scorePage').style.display = 'block';
    userDisplay.innerText = `Logged in as @${user}`;
    scoreDisplay.innerText = data.score.toLocaleString();
  } else if (data) {
    alert(data.error || 'Login nahi hua');
  }
}

async function handleRegister() {
  const user = usernameInput.value.trim();
  const pass = passwordInput.value.trim();
  if (!user || !pass) return alert("Sab daal bhai!");

  const data = await safeFetch('/api/register', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username: user, password: pass })
  });

  if (data && data.success) {
    alert('Registered! Ab login kar.');
  } else if (data) {
    alert(data.error || 'Register nahi hua');
  }
}

async function fakeBoost() {
  if (!currentUser) return alert("Login pehle kar!");
  const data = await safeFetch('/api/boost', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username: currentUser })
  });

  if (data && data.success) {
    scoreDisplay.innerText = data.newScore.toLocaleString();
    alert(`+${data.increase.toLocaleString()} points add ho gaye! ðŸ”¥`);
  }
}

function openSettings() {
  if (!currentUser) return;
  modalUser.innerText = currentUser;
  modalPass.innerText = localStorage.getItem('snapPass') || 'Chhupa hua';
  modal.style.display = 'flex';
}

function closeSettings() { modal.style.display = 'none'; }

function logout() {
  if (confirm("Log out karna hai?")) {
    currentUser = null;
    localStorage.clear();
    location.reload();
  }
}

window.onload = () => {
  const saved = localStorage.getItem('snapUser');
  if (saved) usernameInput.value = saved;
};

window.onclick = e => { if (e.target === modal) closeSettings(); };
</script>
